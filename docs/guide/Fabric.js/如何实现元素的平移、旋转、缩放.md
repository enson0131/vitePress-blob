# å¦‚ä½•å®žçŽ°å…ƒç´ çš„å¹³ç§»ã€æ—‹è½¬ã€ç¼©æ”¾

åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“äº†å…ƒç´ æ˜¯å¦‚ä½•æ¸²æŸ“åˆ° Canvas çš„ç”»å¸ƒä¸Šï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬å°†äº†è§£å¦‚ä½•å¯¹å…ƒç´ è¿›è¡Œå¹³ç§»ã€æ—‹è½¬ã€ç¼©æ”¾ã€‚

## å¦‚ä½•å¹³ç§»ã€æ—‹è½¬ã€ç¼©æ”¾å…ƒç´ 

åœ¨ä¸Šä¸€èŠ‚æˆ‘ä»¬çŸ¥é“ï¼Œå…ƒç´ éƒ½ç»§æ‰¿è‡ª fabric.Objectï¼Œè€Œ fabric.Object çš„ render æ–¹æ³•éƒ½ç”±å„ä¸ªå…ƒç´ å®žçŽ°ã€‚é‚£ä¹ˆå¯¹äºŽå…ƒç´ çš„å¹³ç§»ã€æ—‹è½¬ã€ç¼©æ”¾ï¼Œæˆ‘ä»¬åˆéœ€è¦å¦‚ä½•æŠ½ç¦»å‡ºé€šç”¨çš„é€»è¾‘å‘¢ï¼Ÿ

ä¸å¦¨æ€è€ƒä¸€ä¸‹ï¼Œè¿™ä¸ªæ¡ˆä¾‹

`
å‡è®¾è¦åœ¨ (100, 100) çš„åœ°æ–¹ç»˜åˆ¶ä¸€ä¸ª 50*50 çš„çŸ©å½¢ï¼Œå¹¶å°†å…¶æ”¾å¤§ 2 å€ï¼Œä¹‹åŽæ—‹è½¬ 45Â°ï¼Œè¯¥æ€Žä¹ˆç”»å‘¢ï¼Ÿ
`

æ­£å¸¸é€»è¾‘æ˜¯ï¼š
1. æ‰‹åŠ¨ç®—ä¸‹å®½é«˜ 100 * 100
2. æ‰‹åŠ¨ç®—ä¸‹æ—‹è½¬ä¹‹åŽå„ä¸ªé¡¶ç‚¹çš„åæ ‡
3. è¿žæŽ¥å››ä¸ªé¡¶ç‚¹


ä¹Ÿå°±æ˜¯æˆ‘ä»¬å…ˆæ‰‹åŠ¨å…ˆè®¡ç®—å‡ºå„ä¸ªè½¬åŒ–åŽçš„åæ ‡ï¼Œé€šè¿‡åæ ‡ç»˜åˆ¶å‡ºå›¾å½¢ã€‚

ä½†åœ¨ Canvas ä¸­ï¼Œ***è¦æ”¹æŽ‰è¿™ç§ç»˜åˆ¶çš„æ€æƒ³ï¼Œè€Œæ˜¯è¦é€šè¿‡å¹¶å–„ç”¨å˜æ¢åæ ‡ç³»æ¥ç»˜åˆ¶ç‰©ä½“***

æ€è·¯å¦‚ä¸‹:
1 ç»˜åˆ¶ä¸€ä¸ª 50*50 çš„çŸ©å½¢
2 è½¬åŒ–åæ ‡ç³»

ä»£ç å¦‚ä¸‹:
```js
ctx.save(); // ä¹‹å‰æåˆ°è¿‡äº†ï¼Œä½ è¦ä¿®æ”¹ ctx ä¸Šçš„ä¸€äº›é…ç½®æˆ–è€…ç”»ä¸€ä¸ªç‰©ä½“ï¼Œæœ€å¥½å…ˆ save ä¸€ä¸‹ï¼Œè¿™æ˜¯ä¸ªå¥½ä¹ æƒ¯
ctx.translate(100, 100); // æ­¤æ—¶åŽŸç‚¹å·²ç»å˜åˆ°äº† (100, 100) çš„åœ°æ–¹
ctx.scale(2, 2); // åæ ‡ç³»æ”¾å¤§ä¸¤å€
ctx.rotate(Util.degreesToRadians(45)); // æ³¨æ„ canvas ä¸­ç”¨çš„éƒ½æ˜¯å¼§åº¦ï¼ˆå¼§åº¦ / 2 * Math.PI = è§’åº¦ / 360)ï¼Œæ‰€ä»¥éœ€è¦ç®€å•æ¢ç®—ä¸‹
ctx.fillRect(-width/2, height/2, width, height); // ç»˜åˆ¶çŸ©å½¢çš„æ–¹æ³•å›ºå®šä¸å˜ï¼Œå®½é«˜ä¸€èˆ¬ä¹Ÿä¸ä¼šåŽ»ä¿®æ”¹
ctx.restore(); // ç”»å®Œä¹‹åŽè¿˜åŽŸ ctx çŠ¶æ€ï¼Œè¿™æ˜¯ä¸ªå¥½ä¹ æƒ¯
```

![alt text](./../../public/assets/fabric/12.png)


***å°½é‡ä¸åŽ»æ”¹å˜ç‰©ä½“çš„å®½é«˜å’Œå¤§å°ï¼Œè€Œæ˜¯é€šè¿‡å„ç§å˜æ¢æ¥è¾¾åˆ°æ‰€éœ€è¦çš„æ•ˆæžœ***


## çŸ©é˜µè¿ç®—

åœ¨ Fabric.js ä¸­ï¼Œå¹¶ä¸æ˜¯é€šè¿‡ translateã€scaleã€rotate è¿™äº›æ–¹æ³•æ¥å®žçŽ°å…ƒç´ çš„å¹³ç§»ã€æ—‹è½¬ã€ç¼©æ”¾ï¼Œè€Œæ˜¯é€šè¿‡çŸ©é˜µè¿ç®—æ¥å®žçŽ°ã€‚

é€šè¿‡ transform api åšçŸ©é˜µå˜åŒ–ï¼Œå‚æ•° æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé‡Œé¢æœ‰6ä¸ªå…ƒç´ ï¼Œé»˜è®¤å€¼æ˜¯ [1, 0, 0, 1, 0, 0]ã€‚

```js
[0]: æ°´å¹³ç¼©æ”¾ï¼ˆxè½´æ–¹å‘ï¼‰
[1]: æ°´å¹³å€¾æ–œï¼ˆxè½´æ–¹å‘ï¼‰
[2]: åž‚ç›´å€¾æ–œï¼ˆyè½´æ–¹å‘ï¼‰
[3]: åž‚ç›´ç¼©æ”¾ï¼ˆyè½´æ–¹å‘ï¼‰
[4]: æ°´å¹³ç§»åŠ¨ï¼ˆxè½´æ–¹å‘ï¼‰
[5]: åž‚ç›´ç§»åŠ¨ï¼ˆyè½´æ–¹å‘
```
1 ä¿®æ”¹ viewportTransform[0]ã€viewportTransform[3] è¾¾åˆ°ç¼©æ”¾æ¨ªçºµåæ ‡çš„å€¼
2 ä¿®æ”¹ viewportTransform[4]ã€viewportTransform[5] è¾¾åˆ°å¹³ç§»ç”»å¸ƒçš„æ•ˆæžœ


![alt text](./../../public/assets/fabric/13.png)


å¯¹äºŽä¸Šé¢è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹ viewportTransform çš„å€¼ï¼Œç„¶åŽé‡æ–°æ¸²æŸ“ç”»å¸ƒå°±å¥½äº†ã€‚

```js

const width = 50;
const height = 50;
const angle = (45 / 180) * Math.PI; // Math.PI / 4
ctx.save();
ctx.transform( // æ—‹è½¬
  2 * Math.cos(angle),
  Math.sin(angle),
  -Math.sin(angle),
  2 * Math.cos(angle),
  100,
  100,
);
ctx.fillRect(-width/2, height/2, width, height); // ç»˜åˆ¶çŸ©å½¢çš„æ–¹æ³•å›ºå®šä¸å˜ï¼Œå®½é«˜ä¸€èˆ¬ä¹Ÿä¸ä¼šåŽ»ä¿®æ”¹
ctx.restore();
```

![alt text](./../../public/assets/fabric/14.png)


åŒæ ·çš„ï¼Œåœ¨ fabric.js ä¸­ï¼Œåœ¨ render æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨ transform æ–¹æ³•ï¼Œå°† viewportTransform çš„å€¼è®¾ç½®ä¸º transform çš„å€¼ï¼Œä»¥è¾¾åˆ°å¯¹å…ƒç´ è¿›è¡Œå¹³ç§»ã€æ—‹è½¬ã€ç¼©æ”¾çš„æ•ˆæžœã€‚

## å¦‚ä½•å®žçŽ°æ¼«æ¸¸

é€šè¿‡ç›‘å¬æ»šè½®äº‹ä»¶ï¼Œç„¶åŽä¿®æ”¹ viewportTransform çš„å€¼ï¼Œä»¥è¾¾åˆ°å¯¹ç”»å¸ƒè¿›è¡Œå¹³ç§»çš„æ•ˆæžœã€‚

```js
canvas.on("mouse:wheel", function (opt) {
   onsole.log("opt", opt);
   const deltaY = opt.e.deltaY;
   const deltaX = opt.e.deltaX;
   zoom *= 0.999 ** deltaY;
   if (zoom > 20) zoom = 20;
   if (zoom < 0.01) zoom = 0.01;
   const vpt = this.viewportTransform;
   console.log("vpt", vpt);
   vpt[0] = zoom; // åœ¨ X è½´æ–¹å‘ä¸Šçš„åç§»é‡ã€‚
   vpt[3] = zoom; // åœ¨ Y è½´æ–¹å‘ä¸Šçš„åç§»é‡ã€‚
   vpt[4] += deltaX; // ä¿©ä¸ªç‚¹çš„ä½ç½®å·®
   vpt[5] += deltaY; // ä¿©ä¸ªç‚¹çš„ä½ç½®å·®
   this.requestRenderAll();
   this.setViewportTransform(this.viewportTransform);

   // let zoom = canvas.getZoom();
   // zoom *= 0.999 ** delta;
   // if (zoom > 20) zoom = 20;
   // if (zoom < 0.01) zoom = 0.01;
   // canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
   opt.e.preventDefault();
   opt.e.stopPropagation();
});

```


æ¼”ç¤ºæ•ˆæžœðŸ‘‡:

![alt text](./../../public/assets/fabric/15.gif)


æ¼”ç¤ºåœ°å€: https://enson0131.github.io/mini-fabric-whiteboard/



## ä»“åº“æ¡ˆä¾‹

https://github.com/enson0131/mini-fabric-whiteboard/blob/master/mini-fabric/src/fabric/FabricObject.ts#L212



## å‚è€ƒæ–‡æ¡£
- https://medium.com/@sagarmohanty2k00/creating-a-digital-whiteboard-element-with-react-js-d4924ee2c58e
- https://fabricjs.com/docs/old-docs/fabric-intro-part-5/
- https://juejin.cn/post/7106023188831666206
- https://juejin.cn/post/7142664492122374158?from=search-suggest
- https://developer.mozilla.org/zh-CN/docs/Web/SVG/Attribute/transform#matrix